name: Tag Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name to release (e.g., v0.1.0)"
        required: true
        type: string

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust & git-cliff
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      - name: Install git-cliff
        run: cargo install git-cliff --force

      - name: Generate changelog
        run: |
          # Get the default branch name
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d' ' -f5)
          echo "Default branch: $DEFAULT_BRANCH"

          # Fetch and checkout to default branch with proper upstream
          git fetch origin $DEFAULT_BRANCH
          if git show-ref --verify --quiet refs/heads/$DEFAULT_BRANCH; then
            git checkout $DEFAULT_BRANCH
            git branch --set-upstream-to=origin/$DEFAULT_BRANCH $DEFAULT_BRANCH
          else
            git checkout -b $DEFAULT_BRANCH origin/$DEFAULT_BRANCH
          fi

          git-cliff -c cliff.toml -o CHANGELOG.md --verbose
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit changelog if changed
        run: |
          # Get the default branch name
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d' ' -f5)
          echo "Default branch: $DEFAULT_BRANCH"

          # Ensure we're on the default branch
          git fetch origin $DEFAULT_BRANCH
          if git show-ref --verify --quiet refs/heads/$DEFAULT_BRANCH; then
            git checkout $DEFAULT_BRANCH
            git branch --set-upstream-to=origin/$DEFAULT_BRANCH $DEFAULT_BRANCH
          else
            git checkout -b $DEFAULT_BRANCH origin/$DEFAULT_BRANCH
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md does not exist. This should not happen."
            exit 1
          fi

          # Check if there are any changes (including new file)
          if git status --porcelain CHANGELOG.md | grep -q .; then
            echo "Changes detected in CHANGELOG.md. Committing..."
            git add CHANGELOG.md
            git commit -m "Update CHANGELOG for $GITHUB_REF"
            git push origin $DEFAULT_BRANCH
            echo "Successfully pushed CHANGELOG.md to $DEFAULT_BRANCH"
          else
            echo "No changes in CHANGELOG.md. Skipping commit."
            echo "Current HEAD: $(git rev-parse HEAD)"
            echo "CHANGELOG.md status:"
            git status CHANGELOG.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: generate-changelog
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      - name: Install git-cliff
        run: cargo install git-cliff --force

      - name: Ensure default branch
        run: |
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | awk '{print $NF}')
          echo "Default branch: $DEFAULT_BRANCH"

          git fetch origin "$DEFAULT_BRANCH"
          git checkout "$DEFAULT_BRANCH"
          git branch --set-upstream-to=origin/"$DEFAULT_BRANCH"

      - name: Determine tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Tag name: ${TAG_NAME}"

      - name: Generate release notes for current tag
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="${{ steps.tag.outputs.tag_name }}"
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${CURRENT_TAG}$" | head -n 1)

          echo "Previous tag: ${PREV_TAG}"
          echo "Current tag:  ${CURRENT_TAG}"

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, generating first release notes"
            git-cliff \
              -c cliff.toml \
              --tag "$CURRENT_TAG" \
              --github-repo "$GITHUB_REPOSITORY" \
              -o RELEASE_NOTES.md \
              --verbose
          else
            echo "Generating release notes for range ${PREV_TAG}..${CURRENT_TAG}"
            git-cliff \
              -c cliff.toml \
              "${PREV_TAG}..${CURRENT_TAG}" \
              --tag "$CURRENT_TAG" \
              --github-repo "$GITHUB_REPOSITORY" \
              -o RELEASE_NOTES.md \
              --verbose
          fi

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ steps.tag.outputs.tag_name }}
          body_path: RELEASE_NOTES.md
          # prerelease: ${{ contains(steps.tag.outputs.tag_name, 'alpha') || contains(steps.tag.outputs.tag_name, 'beta') }}
